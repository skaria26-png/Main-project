<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Price Predictor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif; background: linear-gradient(135deg, #e6ebf4, #cfd8e6); min-height: 100vh; padding: 20px; color: #2c3e50; }
    .container { max-width: 1300px; margin: 0 auto; background: #fff; border-radius: 18px; box-shadow: 0 18px 40px rgba(0,0,0,0.08); overflow: hidden; }
    .header { background: linear-gradient(135deg, #2c3e50, #3e4a5a); color: #fff; padding: 28px; text-align: center; }
    .header h1 { font-weight: 600; letter-spacing: 0.3px; }
    .sub { opacity: 0.9; font-weight: 400; margin-top: 6px; }
    .content-grid { display: grid; grid-template-columns: 1fr 340px; }
    .primary { padding: 26px; }
    .sidebar { background: linear-gradient(180deg,#f7f9fc,#eef2f7); padding: 22px; border-left: 1px solid #e3e8f0; }
    .search-row { display: grid; gap: 12px; grid-template-columns: 1fr auto; align-items: center; }
    .search-input { width: 100%; padding: 14px 16px; border: 2px solid #e3e8f0; border-radius: 14px; outline: none; font-size: 15px; transition: box-shadow .2s, border-color .2s; }
    .search-input:focus { border-color: #5b7bd5; box-shadow: 0 0 0 4px rgba(91,123,213,0.15); }
    .btn { padding: 12px 18px; border-radius: 12px; border: none; background: linear-gradient(135deg,#5b7bd5,#6b8fe9); color: #fff; font-weight: 600; cursor: pointer; transition: transform .15s ease, box-shadow .15s ease; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(91,123,213,0.25); }
    .timeframes { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .tf { padding: 8px 14px; border-radius: 20px; border: 2px solid #e3e8f0; background: #fff; font-weight: 600; cursor: pointer; }
    .tf.active { background: #5b7bd5; color: #fff; border-color: #5b7bd5; }
    .card { background: #fff; border-radius: 14px; padding: 18px; box-shadow: 0 8px 18px rgba(0,0,0,0.06); margin-top: 18px; }
    .chart-card canvas { height: 260px; max-height: 260px; }
    .title { font-weight: 700; margin-bottom: 10px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 14px; }
    .info { background: #f3f6fb; border-left: 4px solid #5b7bd5; border-radius: 10px; padding: 12px; text-align: center; }
    .info .label { color: #6b7a90; font-size: 12px; text-transform: uppercase; letter-spacing: .3px; margin-bottom: 6px; }
    .info .value { font-size: 20px; font-weight: 700; }
    .kpis { display: grid; gap: 12px; }
    .kpi { display: flex; justify-content: space-between; align-items: center; background: #f3f6fb; border-left: 3px solid #5b7bd5; border-radius: 10px; padding: 12px; }
    .muted { color: #6b7a90; }
    .bull { color: #1f9d57; font-weight: 700; }
    .bear { color: #d64545; font-weight: 700; }
    .notice { font-size: 13px; color: #6b7a90; line-height: 1.5; }
    @media (max-width: 920px) { 
      .content-grid { grid-template-columns: 1fr; } 
      .sidebar { border-left: none; border-top: 1px solid #e3e8f0; }
      #investmentAnalysis .grid { grid-template-columns: 1fr; }
      #investmentAnalysis .strategy-buttons { flex-direction: column; }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
      <h1>Stock Price Predictor</h1>
      <div class="sub">NASDAQ-first real data, technicals, and 30-day outlook</div>
    </div>
    <div class="content-grid">
      <div class="primary">
        <div class="search-row">
          <input id="stockInput" class="search-input" placeholder="Type company or symbol (e.g., Apple or AAPL)" list="stockSuggestions">
          <datalist id="stockSuggestions"></datalist>
          <button class="btn" id="analyzeBtn">Analyze</button>
        </div>
        <div class="timeframes">
          <button class="tf active" data-days="7" data-range="7d">1W</button>
          <button class="tf" data-days="30" data-range="1mo">1M</button>
          <button class="tf" data-days="90" data-range="3mo">3M</button>
          <button class="tf" data-days="180" data-range="6mo">6M</button>
        </div>
        <div style="margin-top:10px; display:flex; gap:10px; align-items:center">
          <span class="muted" style="font-size:13px">Provider</span>
          <select id="providerSelect" class="search-input" style="max-width:220px; padding:8px 10px; height:auto" disabled>
            <option value="alpha_vantage">Alpha Vantage (Real-time) [ONLY SOURCE]</option>
          </select>
        </div>

        <div class="card chart-card">
          <div class="title" id="histTitle">Historical Price</div>
          <canvas id="priceChart"></canvas>
            </div>

        <div class="card chart-card">
          <div class="title" id="predictionTitle">30-Day Prediction</div>
          
          <!-- Prediction Timeframe Selection -->
          <div style="display: flex; gap: 8px; margin-bottom: 15px; justify-content: center;">
            <button class="tf prediction-tf active" data-days="1" data-label="1 Day">1D</button>
            <button class="tf prediction-tf" data-days="7" data-label="1 Week">1W</button>
            <button class="tf prediction-tf" data-days="30" data-label="30 Days">30D</button>
          </div>
          
          <canvas id="predictionChart"></canvas>
          
          <!-- Prediction Summary -->
          <div id="predictionSummary" style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 13px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
              <div class="info">
                <div class="label">Prediction Period</div>
                <div class="value" id="predictionPeriod">-</div>
              </div>
              <div class="info">
                <div class="label">Expected Change</div>
                <div class="value" id="expectedChange">-</div>
              </div>
              <div class="info">
                <div class="label">Confidence</div>
                <div class="value" id="predictionConfidence">-</div>
              </div>
              <div class="info">
                <div class="label">Target Price</div>
                <div class="value" id="targetPrice">-</div>
              </div>
            </div>
          </div>
            </div>

        <div class="card" id="results" style="display:none">
          <div class="grid" id="stockInfo"></div>
          <div style="margin-top:12px">
            <div id="predictionText" class="muted"></div>
                        </div>
                    </div>

        <!-- Investment Analysis Section -->
        <div class="card" id="investmentAnalysis" style="display:none; margin-top: 20px;">
          <div class="title" style="font-size: 18px; margin-bottom: 20px;">üìä Investment Analysis & Recommendations</div>
          
          <!-- Strategy Selection -->
          <div class="strategy-buttons" style="display: flex; gap: 12px; margin-bottom: 20px; justify-content: center;">
            <button id="dayTradingBtn" class="btn" style="padding: 10px 20px; font-size: 14px; background: #5b7bd5; min-width: 120px;">Day Trading</button>
            <button id="longTermBtn" class="btn" style="padding: 10px 20px; font-size: 14px; background: #6b7a90; min-width: 120px;">Long Term</button>
          </div>

          <!-- Main Recommendation Card -->
          <div id="mainRecommendation" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
            <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #2c3e50;">Current Recommendation</div>
            <div id="recommendationText" style="font-size: 18px; font-weight: 700; margin-bottom: 12px;"></div>
            <div id="confidenceLevel" style="font-size: 14px; color: #6b7a90;"></div>
          </div>

          <!-- Detailed Analysis Grid -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            
            <!-- Technical Signals -->
            <div style="background: #fff; border-radius: 10px; padding: 15px; border-left: 4px solid #5b7bd5;">
              <div style="font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üîç Technical Signals</div>
              <div id="technicalSignals" style="font-size: 13px; line-height: 1.5;"></div>
            </div>

            <!-- Risk Assessment -->
            <div style="background: #fff; border-radius: 10px; padding: 15px; border-left: 4px solid #d64545;">
              <div style="font-weight: 600; margin-bottom: 10px; color: #2c3e50;">‚ö†Ô∏è Risk Assessment</div>
              <div id="riskAssessment" style="font-size: 13px; line-height: 1.5;"></div>
            </div>
          </div>

          <!-- Strategy Guidelines -->
          <div id="strategyGuidelines" style="background: #fff; border-radius: 10px; padding: 15px; border-left: 4px solid #1f9d57;">
            <div style="font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üìã Strategy Guidelines</div>
            <div id="guidelinesContent" style="font-size: 13px; line-height: 1.5;"></div>
          </div>

          <!-- Alpha Vantage Technical Indicators -->
          <div id="alphaVantageIndicators" style="background: #fff; border-radius: 10px; padding: 15px; border-left: 4px solid #8e44ad; margin-top: 15px;">
            <div style="font-weight: 600; margin-bottom: 10px; color: #2c3e50;">üìä Alpha Vantage Technical Indicators</div>
            <div id="indicatorsContent" style="font-size: 13px; line-height: 1.5;">
              <div style="color: #6b7a90;">Click "Load Alpha Vantage Indicators" to get professional technical analysis</div>
            </div>
            <button id="loadIndicatorsBtn" class="btn" style="margin-top: 10px; padding: 8px 12px; font-size: 12px;">Load Alpha Vantage Indicators</button>
                        </div>
                    </div>
                </div>
      <div class="sidebar">
        <div class="card">
          <div class="title">Quick KPIs</div>
          <div class="kpis">
            <div class="kpi"><span class="muted">Current Price</span><span id="kpiPrice">-</span></div>
            <div class="kpi"><span class="muted">Change</span><span id="kpiChange">-</span></div>
            <div class="kpi"><span class="muted">Volume</span><span id="kpiVolume">-</span></div>
            <div class="kpi"><span class="muted">Market Cap</span><span id="kpiMcap">-</span></div>
            <div class="kpi"><span class="muted">P/E</span><span id="kpiPE">-</span></div>
            <div class="kpi"><span class="muted">Prev Close</span><span id="kpiPrev">-</span></div>
            <div class="kpi"><span class="muted">Day High</span><span id="kpiHigh">-</span></div>
            <div class="kpi"><span class="muted">Day Low</span><span id="kpiLow">-</span></div>
          </div>
                    </div>
        <div class="card">
          <div class="title">Market Mood</div>
          <div style="text-align:center">
            <canvas id="moodChart" style="max-width:200px; max-height:200px"></canvas>
            <div style="display:flex; justify-content:space-around; margin-top:10px">
              <div><div id="bullPct" class="bull">0%</div><div class="muted" style="font-size:12px">Bullish</div></div>
              <div><div id="bearPct" class="bear">0%</div><div class="muted" style="font-size:12px">Bearish</div></div>
                        </div>
                    </div>
                </div>
        <div class="card">
          <div class="title">Data Comparison</div>
          <div id="dataComparison" style="font-size:12px; color:#666;">
            <div>Click "Test Alpha Vantage" to verify data accuracy</div>
          </div>
          <button id="testProvidersBtn" class="btn" style="margin-top:10px; padding:8px 12px; font-size:12px;">Test Alpha Vantage</button>
                    </div>
        <div class="card">
          <div class="title">Data Source</div>
          <div class="notice">
            <strong>Primary:</strong> <a href="https://www.alphavantage.co/" target="_blank" style="color:#5b7bd5;">Alpha Vantage</a> (Real-time & Historical)<br>
            <strong>Free API Key:</strong> Sign up at alphavantage.co for accurate real-time data<br>
            <strong>Features:</strong> 20+ years historical data, technical indicators, real-time quotes<br>
            <strong>‚ö†Ô∏è Important:</strong> Replace 'YOUR_API_KEY_HERE' in code with your actual Alpha Vantage API key for accurate prices that match Google Finance
          </div>
        </div>
        
        <div class="card">
          <div class="title">Important Notice</div>
          <div class="notice">This tool uses public market data for educational purposes and is not financial advice.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const stockDataCache = { quotes: new Map(), history: new Map(), suggestions: new Map() };
    const CACHE_DURATION = 1000 * 60 * 5; // 5 minutes

    // Built-in popular companies for instant lookup (prioritize NASDAQ, then NYSE)
    const localCompanies = [
      { s: 'AAPL', n: 'Apple Inc.', e: 'NASDAQ' },
      { s: 'MSFT', n: 'Microsoft Corporation', e: 'NASDAQ' },
      { s: 'NVDA', n: 'NVIDIA Corporation', e: 'NASDAQ' },
      { s: 'TSLA', n: 'Tesla, Inc.', e: 'NASDAQ' },
      { s: 'AMZN', n: 'Amazon.com, Inc.', e: 'NASDAQ' },
      { s: 'GOOGL', n: 'Alphabet Inc. Class A', e: 'NASDAQ' },
      { s: 'GOOG', n: 'Alphabet Inc. Class C', e: 'NASDAQ' },
      { s: 'META', n: 'Meta Platforms, Inc.', e: 'NASDAQ' },
      { s: 'NFLX', n: 'Netflix, Inc.', e: 'NASDAQ' },
      { s: 'AVGO', n: 'Broadcom Inc.', e: 'NASDAQ' },
      { s: 'AMD', n: 'Advanced Micro Devices, Inc.', e: 'NASDAQ' },
      { s: 'INTC', n: 'Intel Corporation', e: 'NASDAQ' },
      { s: 'QCOM', n: 'QUALCOMM Incorporated', e: 'NASDAQ' },
      { s: 'ADI', n: 'Analog Devices, Inc.', e: 'NASDAQ' },
      { s: 'MU', n: 'Micron Technology, Inc.', e: 'NASDAQ' },
      { s: 'CRWD', n: 'CrowdStrike Holdings, Inc.', e: 'NASDAQ' },
      { s: 'PANW', n: 'Palo Alto Networks, Inc.', e: 'NASDAQ' },
      { s: 'SNOW', n: 'Snowflake Inc.', e: 'NYSE' },
      { s: 'SHOP', n: 'Shopify Inc.', e: 'NYSE' },
      { s: 'ABNB', n: 'Airbnb, Inc.', e: 'NASDAQ' },
      { s: 'UBER', n: 'Uber Technologies, Inc.', e: 'NYSE' },
      { s: 'LYFT', n: 'Lyft, Inc.', e: 'NASDAQ' },
      { s: 'ORCL', n: 'Oracle Corporation', e: 'NYSE' },
      { s: 'JPM', n: 'JPMorgan Chase & Co.', e: 'NYSE' },
      { s: 'BAC', n: 'Bank of America Corporation', e: 'NYSE' },
      { s: 'WFC', n: 'Wells Fargo & Company', e: 'NYSE' },
      { s: 'V', n: 'Visa Inc.', e: 'NYSE' },
      { s: 'MA', n: 'Mastercard Incorporated', e: 'NYSE' },
      { s: 'KO', n: 'The Coca-Cola Company', e: 'NYSE' },
      { s: 'PEP', n: 'PepsiCo, Inc.', e: 'NASDAQ' },
      { s: 'MCD', n: 'McDonald\'s Corporation', e: 'NYSE' },
      { s: 'DIS', n: 'The Walt Disney Company', e: 'NYSE' },
      { s: 'NKE', n: 'NIKE, Inc.', e: 'NYSE' },
      { s: 'T', n: 'AT&T Inc.', e: 'NYSE' },
      { s: 'VZ', n: 'Verizon Communications Inc.', e: 'NYSE' },
      { s: 'XOM', n: 'Exxon Mobil Corporation', e: 'NYSE' },
      { s: 'CVX', n: 'Chevron Corporation', e: 'NYSE' },
      { s: 'PFE', n: 'Pfizer Inc.', e: 'NYSE' },
      { s: 'JNJ', n: 'Johnson & Johnson', e: 'NYSE' },
      { s: 'MRK', n: 'Merck & Co., Inc.', e: 'NYSE' },
      { s: 'UNH', n: 'UnitedHealth Group Incorporated', e: 'NYSE' },
      { s: 'LLY', n: 'Eli Lilly and Company', e: 'NYSE' },
      { s: 'COST', n: 'Costco Wholesale Corporation', e: 'NASDAQ' },
      { s: 'HD', n: 'The Home Depot, Inc.', e: 'NYSE' },
      { s: 'LOW', n: 'Lowe\'s Companies, Inc.', e: 'NYSE' },
      { s: 'TSM', n: 'Taiwan Semiconductor Manufacturing Company Limited', e: 'NYSE' },
      { s: 'BABA', n: 'Alibaba Group Holding Limited', e: 'NYSE' },
      { s: 'SONY', n: 'Sony Group Corporation', e: 'NYSE' },
      { s: 'PLTR', n: 'Palantir Technologies Inc.', e: 'NYSE' },
      { s: 'SQ', n: 'Block, Inc.', e: 'NYSE' },
      { s: 'PYPL', n: 'PayPal Holdings, Inc.', e: 'NASDAQ' },
      { s: 'IBM', n: 'International Business Machines Corporation', e: 'NYSE' },
      { s: 'CRM', n: 'Salesforce, Inc.', e: 'NYSE' },
      { s: 'ADBE', n: 'Adobe Inc.', e: 'NASDAQ' },
      { s: 'INTU', n: 'Intuit Inc.', e: 'NASDAQ' },
      { s: 'SPOT', n: 'Spotify Technology S.A.', e: 'NYSE' },
      { s: 'NET', n: 'Cloudflare, Inc.', e: 'NYSE' },
      { s: 'ZM', n: 'Zoom Video Communications, Inc.', e: 'NASDAQ' },
      { s: 'DOCU', n: 'DocuSign, Inc.', e: 'NASDAQ' },
      { s: 'ETSY', n: 'Etsy, Inc.', e: 'NASDAQ' },
      { s: 'ROKU', n: 'Roku, Inc.', e: 'NASDAQ' },
      { s: 'F', n: 'Ford Motor Company', e: 'NYSE' },
      { s: 'GM', n: 'General Motors Company', e: 'NYSE' }
    ];

    let currentSymbol = null;
    let currentExchange = null;
    let currentQuote = null;
    let currentHistory = null;
    let selectedRange = '7d';
    let selectedDays = 7;
    let selectedPredictionDays = 1;
    let priceChart = null;
    let predictionChart = null;
    let moodChart = null;
    let liveTimer = null;

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function formatCurrency(n, c = 'USD') {
      if (n == null || isNaN(n)) return '-';
      try { return new Intl.NumberFormat('en-US', { style: 'currency', currency: c, maximumFractionDigits: 2 }).format(n); } catch { return `$${Number(n).toFixed(2)}`; }
    }
    function formatNumber(n) { return n == null ? '-' : new Intl.NumberFormat('en-US').format(n); }
    function formatMcap(n) { if (n == null) return '-'; if (n >= 1e12) return `${(n/1e12).toFixed(2)}T`; if (n >= 1e9) return `${(n/1e9).toFixed(2)}B`; if (n >= 1e6) return `${(n/1e6).toFixed(2)}M`; return formatNumber(n); }

    // Deterministic RNG and fallbacks (ensures graphs even when offline)
    function createSeededRng(seed) {
      let state = 0;
      for (let i = 0; i < seed.length; i++) state = (state * 31 + seed.charCodeAt(i)) >>> 0;
      return function() { state = (1103515245 * state + 12345) % 0x80000000; return state / 0x80000000; };
    }

    function generateFallbackQuote(symbol) {
      const rng = createSeededRng(symbol);
      const base = 50 + Math.floor(rng() * 400);
      const change = (rng() - 0.5) * 5;
      const price = Math.max(5, base + change);
      return {
        provider: 'fallback',
        symbol,
        name: (localCompanies.find(c => c.s === symbol)?.n) || symbol,
        price,
        change,
        changePercent: (change / (price - change)) * 100,
        volume: Math.floor(5_000_000 + rng() * 50_000_000),
        marketCap: Math.floor(price * (200_000_000 + rng() * 2_000_000_000)),
        pe: Math.round(10 + rng() * 35),
        previousClose: price - change,
        dayHigh: price + Math.abs(change) * 1.4,
        dayLow: price - Math.abs(change) * 1.4,
        currency: 'USD',
        exchangeName: (localCompanies.find(c => c.s === symbol)?.e) || '‚Äî'
      };
    }

    function daysForRange(range) {
      if (range === '7d') return 7; if (range === '1mo') return 30; if (range === '3mo') return 90; if (range === '6mo') return 180; return 60;
    }

    function generateFallbackHistory(symbol, range) {
      const n = daysForRange(range);
      const rng = createSeededRng(symbol + 'hist' + range);
      const baseQuote = generateFallbackQuote(symbol);
      const base = baseQuote.price;
      const out = [];
      let p = base;
      for (let i = n - 1; i >= 0; i--) {
        const drift = (rng() - 0.5) * 0.01; // gentle drift
        const season = Math.sin((n - i) / 8) * 0.008;
        const vol = (rng() - 0.5) * 0.02;
        p = Math.max(3, p * (1 + drift + season + vol));
        out.push({ date: new Date(Date.now() - i * 86400000), price: p });
      }
      return out;
    }

    async function resolveSymbolFromApi(query) {
      const key = query.toLowerCase();
      const now = Date.now();
      const cached = stockDataCache.suggestions.get(key);
      if (cached && now - cached.t < CACHE_DURATION) return cached.v;

      const url = `https://query2.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(query)}&quotesCount=10&newsCount=0`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Search failed');
      const data = await res.json();
      const quotes = (data.quotes || []).filter(q => q.quoteType === 'EQUITY');
      const nasdaq = quotes.filter(q => q.exchDisp === 'NASDAQ' || q.exchange === 'NMS');
      const nyse = quotes.filter(q => q.exchDisp === 'NYSE' || q.exchange === 'NYQ');
      const ordered = [...nasdaq, ...nyse, ...quotes];
      stockDataCache.suggestions.set(key, { t: now, v: ordered });
      return ordered;
    }

    // Alpha Vantage API functions
    async function fetchAlphaVantageQuote(symbol) {
      // Try multiple API keys for better reliability
      const apiKeys = [
        'demo', // Demo key
        'YOUR_API_KEY_HERE' // Replace with your actual Alpha Vantage API key
      ];
      
      for (const apiKey of apiKeys) {
        try {
          const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(symbol)}&apikey=${apiKey}`;
          
          const res = await fetch(url);
          if (!res.ok) continue;
          
          const data = await res.json();
          
          if (data['Error Message']) continue;
          if (data['Note']) continue; // Skip rate limited keys
          
          const quote = data['Global Quote'];
          if (!quote || !quote['01. symbol']) continue;
          
          // Get company name from local companies list
          const companyInfo = localCompanies.find(c => c.s === symbol.toUpperCase());
          
          return {
            provider: 'alpha_vantage',
            symbol: quote['01. symbol'],
            name: companyInfo?.n || quote['01. symbol'],
            price: parseFloat(quote['05. price']),
            change: parseFloat(quote['09. change']),
            changePercent: parseFloat(quote['10. change percent'].replace('%', '')),
            volume: parseInt(quote['06. volume']),
            marketCap: null, // Not provided in Global Quote
            pe: null, // Not provided in Global Quote
            previousClose: parseFloat(quote['08. previous close']),
            dayHigh: parseFloat(quote['03. high']),
            dayLow: parseFloat(quote['04. low']),
            currency: 'USD',
            exchangeName: companyInfo?.e || '‚Äî',
            marketState: 'REGULAR',
            session: 'REGULAR',
            asOfISO: new Date().toISOString(),
            isDelayed: false,
            dataQuality: 'real-time'
          };
        } catch (error) {
          console.log(`API key ${apiKey} failed:`, error.message);
          continue;
        }
      }
      
      throw new Error('All Alpha Vantage API keys failed');
    }

    async function fetchAlphaVantageHistory(symbol, range) {
      // Try multiple API keys for better reliability
      const apiKeys = [
        'demo', // Demo key
        'YOUR_API_KEY_HERE' // Replace with your actual Alpha Vantage API key
      ];
      
      // Map range to Alpha Vantage function
      let function_name;
      if (range === '7d' || range === '1mo') {
        function_name = 'TIME_SERIES_DAILY';
      } else if (range === '3mo') {
        function_name = 'TIME_SERIES_WEEKLY';
      } else {
        function_name = 'TIME_SERIES_MONTHLY';
      }
      
      for (const apiKey of apiKeys) {
        try {
          const url = `https://www.alphavantage.co/query?function=${function_name}&symbol=${encodeURIComponent(symbol)}&apikey=${apiKey}&outputsize=compact`;
          
          const res = await fetch(url);
          if (!res.ok) continue;
          
          const data = await res.json();
          
          if (data['Error Message']) continue;
          if (data['Note']) continue; // Skip rate limited keys
          
          // Extract time series data
          const timeSeriesKey = function_name === 'TIME_SERIES_DAILY' ? 'Time Series (Daily)' :
                               function_name === 'TIME_SERIES_WEEKLY' ? 'Weekly Time Series' :
                               'Monthly Time Series';
          
          const timeSeries = data[timeSeriesKey];
          if (!timeSeries) continue;
          
          const out = [];
          const entries = Object.entries(timeSeries);
          
          // Sort by date (newest first) and take appropriate number of days
          entries.sort((a, b) => new Date(b[0]) - new Date(a[0]));
          
          const daysToTake = range === '7d' ? 7 : range === '1mo' ? 30 : range === '3mo' ? 90 : 180;
          const limitedEntries = entries.slice(0, daysToTake);
          
          for (const [date, values] of limitedEntries) {
            out.push({
              date: new Date(date),
              price: parseFloat(values['4. close']),
              open: parseFloat(values['1. open']),
              high: parseFloat(values['2. high']),
              low: parseFloat(values['3. low']),
              volume: parseInt(values['5. volume'])
            });
          }
          
          // Reverse to get chronological order (oldest first)
          return out.reverse();
        } catch (error) {
          console.log(`History API key ${apiKey} failed:`, error.message);
          continue;
        }
      }
      
      throw new Error('All Alpha Vantage history API keys failed');
    }

    async function fetchAlphaVantageTechnicalIndicator(symbol, indicator, interval = 'daily', time_period = 14) {
      // Try multiple API keys for better reliability
      const apiKeys = [
        'demo', // Demo key
        'YOUR_API_KEY_HERE' // Replace with your actual Alpha Vantage API key
      ];
      
      for (const apiKey of apiKeys) {
        try {
          const url = `https://www.alphavantage.co/query?function=${indicator}&symbol=${encodeURIComponent(symbol)}&interval=${interval}&time_period=${time_period}&series_type=close&apikey=${apiKey}`;
          
          const res = await fetch(url);
          if (!res.ok) continue;
          
          const data = await res.json();
          
          if (data['Error Message']) continue;
          if (data['Note']) continue; // Skip rate limited keys
          
          return data;
        } catch (error) {
          console.log(`Technical indicator API key ${apiKey} failed:`, error.message);
          continue;
        }
      }
      
      throw new Error(`All Alpha Vantage ${indicator} API keys failed`);
    }

    // Alpha Vantage only - no other data sources

    async function updateSuggestions(e) {
      const val = e.target.value.trim();
      const dl = document.getElementById('stockSuggestions');
      if (!val) { dl.innerHTML = ''; populateInitialDatalist(); return; }
      let merged = [];
      try {
        const results = await resolveSymbolFromApi(val);
        merged = results.map(q => ({ s: q.symbol, n: q.longname || q.shortname || q.symbol, e: q.exchDisp || q.exchange || '' }));
      } catch {
        merged = [];
      }
      const localMatches = localCompanies.filter(c => c.s.startsWith(val.toUpperCase()) || c.n.toLowerCase().includes(val.toLowerCase()));
      merged = [...localMatches, ...merged];
      // Dedupe by symbol
      const seen = new Set();
      const deduped = [];
      for (const item of merged) { if (!seen.has(item.s)) { seen.add(item.s); deduped.push(item); } }

      dl.innerHTML = '';
      deduped.slice(0, 20).forEach(q => {
        const opt = document.createElement('option');
        opt.value = q.s;
        opt.label = `${q.n} (${q.e || '‚Äî'})`;
        dl.appendChild(opt);
      });
    }

    // Removed Yahoo Finance functions - Alpha Vantage only

    // Alpha Vantage only - with fallback for demo purposes
    async function safeFetchLiveQuote(symbol) {
      try { 
        return await fetchAlphaVantageQuote(symbol); 
      } catch (error) {
        console.log('Alpha Vantage failed, using fallback data:', error.message);
        return generateFallbackQuote(symbol);
      }
    }
    
    async function safeFetchStockHistory(symbol, range) {
      try { 
        return await fetchAlphaVantageHistory(symbol, range); 
      } catch (error) {
        console.log('Alpha Vantage history failed, using fallback data:', error.message);
        return generateFallbackHistory(symbol, range);
      }
    }

    function calculateEMA(values, period) {
      if (values.length === 0) return 0;
      const k = 2 / (period + 1);
      let ema = values[0];
      for (let i = 1; i < values.length; i++) ema = values[i] * k + ema * (1 - k);
            return ema;
        }
    function calculateSMA(values, period) {
      if (values.length < period) return values[values.length - 1] ?? 0;
      const slice = values.slice(-period);
      const sum = slice.reduce((a, b) => a + b, 0);
            return sum / period;
        }
    function calculateRSI(values, period = 14) {
      if (values.length < period + 1) return 50;
      let gains = 0, losses = 0;
      for (let i = values.length - period; i < values.length; i++) {
        const diff = values[i] - values[i - 1];
        if (diff > 0) gains += diff; else losses -= diff;
      }
      const avgGain = gains / period, avgLoss = losses / period;
      if (avgLoss === 0) return 100;
      const rs = avgGain / avgLoss;
      return 100 - 100 / (1 + rs);
    }
    function calculateMACD(values) {
      if (values.length < 40) return { macd: 0, signal: 0, histogram: 0 };
      const ema12 = calculateEMA(values, 20);
      const ema26 = calculateEMA(values, 40);
      const macd = ema12 - ema26;
      const signal = macd * 0.9; // simplified
      return { macd, signal, histogram: macd - signal };
    }
    function calculateVolatility(values) {
      if (values.length < 2) return 0;
      const rets = [];
      for (let i = 1; i < values.length; i++) rets.push((values[i] - values[i-1]) / values[i-1]);
      const mean = rets.reduce((a,b)=>a+b,0)/rets.length;
      const varc = rets.reduce((a,r)=>a+Math.pow(r-mean,2),0)/rets.length;
      return Math.sqrt(varc);
    }

    // Professional technical indicators used by institutional traders
    function calculateBollingerBands(prices, period = 20, stdDev = 2) {
      if (prices.length < period) return { upper: 0, middle: 0, lower: 0 };
      const sma = calculateSMA(prices, period);
      const slice = prices.slice(-period);
      const variance = slice.reduce((acc, price) => acc + Math.pow(price - sma, 2), 0) / period;
      const std = Math.sqrt(variance);
      return {
        upper: sma + (stdDev * std),
        middle: sma,
        lower: sma - (stdDev * std)
      };
    }

    function calculateStochastic(prices, kPeriod = 14, dPeriod = 3) {
      if (prices.length < kPeriod) return { k: 50, d: 50 };
      const slice = prices.slice(-kPeriod);
      const high = Math.max(...slice);
      const low = Math.min(...slice);
      const current = prices[prices.length - 1];
      const k = ((current - low) / (high - low)) * 100;
      
      // Simple D calculation (3-period SMA of K)
      const kValues = [];
      for (let i = kPeriod - 1; i < prices.length; i++) {
        const periodSlice = prices.slice(i - kPeriod + 1, i + 1);
        const periodHigh = Math.max(...periodSlice);
        const periodLow = Math.min(...periodSlice);
        const periodK = ((prices[i] - periodLow) / (periodHigh - periodLow)) * 100;
        kValues.push(periodK);
      }
      const d = calculateSMA(kValues, dPeriod);
      return { k, d };
    }

    function calculateWilliamsR(prices, period = 14) {
      if (prices.length < period) return 0;
      const slice = prices.slice(-period);
      const high = Math.max(...slice);
      const low = Math.min(...slice);
      const current = prices[prices.length - 1];
      return ((high - current) / (high - low)) * -100;
    }

    function calculateATR(prices, period = 14) {
      if (prices.length < period + 1) return 0;
      const trueRanges = [];
      for (let i = 1; i < prices.length; i++) {
        const high = prices[i];
        const low = prices[i - 1];
        const prevClose = prices[i - 1];
        const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
        trueRanges.push(tr);
      }
      return calculateSMA(trueRanges.slice(-period), period);
    }

    async function fetchAlphaVantageIndicators(symbol) {
      try {
        const [rsiData, macdData, sma20Data, sma50Data] = await Promise.all([
          fetchAlphaVantageTechnicalIndicator(symbol, 'RSI', 'daily', 14),
          fetchAlphaVantageTechnicalIndicator(symbol, 'MACD', 'daily'),
          fetchAlphaVantageTechnicalIndicator(symbol, 'SMA', 'daily', 20),
          fetchAlphaVantageTechnicalIndicator(symbol, 'SMA', 'daily', 50)
        ]);
        
        return {
          rsi: rsiData['Technical Analysis: RSI'],
          macd: macdData['Technical Analysis: MACD'],
          sma20: sma20Data['Technical Analysis: SMA'],
          sma50: sma50Data['Technical Analysis: SMA']
        };
      } catch (error) {
        console.log('Alpha Vantage indicators failed, using calculated values:', error.message);
        return null;
      }
    }

    function generatePrediction(quote, history) {
      try {
        const prices = history.map(d => d.price);
        if (prices.length === 0) {
          return { direction: 'bullish', confidence: 50, bullishRatio: 0.5, indicators: {} };
        }
        
        const rsi = calculateRSI(prices);
        const macd = calculateMACD(prices);
        const sma20 = calculateSMA(prices, 20);
        const sma50 = calculateSMA(prices, 50);
        const sma5 = calculateSMA(prices, 5);
        const sma10 = calculateSMA(prices, 10);
        const current = prices[prices.length - 1];

      // Professional indicators
      const bb = calculateBollingerBands(prices);
      const stoch = calculateStochastic(prices);
      const williamsR = calculateWilliamsR(prices);
      const atr = calculateATR(prices);

      let bull = 0, bear = 0;

      // RSI Analysis (Fixed - more balanced)
      if (rsi < 30) bull += 2; // Oversold - strong buy signal
      else if (rsi > 70) bear += 2; // Overbought - strong sell signal
      else if (rsi < 45) bull += 1; // Weak oversold - buy signal
      else if (rsi > 55) bear += 1; // Weak overbought - sell signal
      else if (rsi >= 50) bull += 0.5; // Above 50 - slightly bullish
      else bull += 0.3; // Below 50 but not oversold - neutral bullish

      // MACD Analysis
      if (macd.macd > macd.signal) bull += 1; else bear += 1;
      if (macd.histogram > 0) bull += 0.5; else bear += 0.5;

      // Moving Average Analysis (Fixed - more balanced)
      if (current > sma20 && sma20 > sma50) bull += 2.5; // Strong uptrend
      else if (current < sma20 && sma20 < sma50) bear += 2.5; // Strong downtrend
      else if (current > sma20) bull += 1.5; // Above short-term MA - bullish
      else if (current > sma50) bull += 0.5; // Above long-term MA - slightly bullish
      else bear += 1; // Below both MAs - bearish

      // Short-term momentum
      if (sma5 > sma10) bull += 1; else bear += 1;

      // Bollinger Bands Analysis (Fixed)
      if (current < bb.lower) bull += 2; // Oversold bounce - strong buy
      else if (current > bb.upper) bear += 2; // Overbought rejection - strong sell
      else if (current > bb.middle) bull += 1; // Above middle - bullish
      else bull += 0.3; // Below middle but not oversold - neutral bullish

      // Stochastic Analysis (Fixed)
      if (stoch.k < 20 && stoch.d < 20) bull += 1.5; // Oversold - strong buy
      else if (stoch.k > 80 && stoch.d > 80) bear += 1.5; // Overbought - strong sell
      else if (stoch.k > stoch.d) bull += 0.8; // K above D - bullish momentum
      else if (stoch.k > 50) bull += 0.3; // Above 50 - slightly bullish
      else bear += 0.5; // Below 50 and K below D - bearish

      // Williams %R Analysis (Fixed)
      if (williamsR < -80) bull += 1.2; // Oversold - strong buy
      else if (williamsR > -20) bear += 1.2; // Overbought - strong sell
      else if (williamsR < -50) bull += 0.5; // Below -50 - bullish
      else bear += 0.3; // Above -50 - slightly bearish

      // Volume Analysis (Fixed - more balanced)
      if (quote.volume && prices.length >= 2) {
        const avgVolume = 30_000_000; // Average volume assumption
        const volumeRatio = quote.volume / avgVolume;
        const priceChange = (current - prices[prices.length-2]) / prices[prices.length-2];
        
        if (volumeRatio > 2) { // High volume
          if (priceChange > 0) bull += 1.5; // High volume + price up = bullish
          else if (priceChange < -0.02) bear += 1.5; // High volume + significant price down = bearish
          else bull += 0.5; // High volume + small change = slightly bullish
        } else if (volumeRatio > 1.5) {
          if (priceChange > 0) bull += 0.8; // Above average volume + price up
          else bear += 0.5; // Above average volume + price down
        } else if (volumeRatio > 1) {
          if (priceChange > 0) bull += 0.3; // Normal volume + price up
          else bear += 0.2; // Normal volume + price down
        }
      }

      // Price Momentum (Fixed - more balanced)
      if (prices.length >= 10) {
        const shortMomentum = (current - prices[prices.length-5]) / prices[prices.length-5];
        const longMomentum = (current - prices[prices.length-10]) / prices[prices.length-10];
        
        // Short-term momentum
        if (shortMomentum > 0.05) bull += 1.5; // Very strong short-term momentum
        else if (shortMomentum > 0.02) bull += 1; // Strong short-term momentum
        else if (shortMomentum > 0) bull += 0.5; // Positive short-term momentum
        else if (shortMomentum < -0.05) bear += 1.5; // Very negative short-term momentum
        else if (shortMomentum < -0.02) bear += 1; // Negative short-term momentum
        else bear += 0.3; // Slightly negative short-term momentum
        
        // Long-term momentum
        if (longMomentum > 0.08) bull += 1.5; // Very strong long-term momentum
        else if (longMomentum > 0.03) bull += 1; // Strong long-term momentum
        else if (longMomentum > 0) bull += 0.5; // Positive long-term momentum
        else if (longMomentum < -0.08) bear += 1.5; // Very negative long-term momentum
        else if (longMomentum < -0.03) bear += 1; // Negative long-term momentum
        else bear += 0.3; // Slightly negative long-term momentum
      }

      // Volatility Analysis (Professional)
      const vol = calculateVolatility(prices);
      if (vol > 0.05) { // High volatility - reduce confidence
        bull *= 0.8;
        bear *= 0.8;
      } else if (vol < 0.01) { // Low volatility - normal confidence
        bull *= 1.1;
        bear *= 1.1;
      }

      // ATR Analysis
      if (atr > 0) {
        const atrRatio = atr / current;
        if (atrRatio > 0.03) { // High volatility
          bull *= 0.9;
          bear *= 0.9;
        }
      }

      // Fundamental Analysis (Fixed - more balanced)
      if (quote.pe) {
        if (quote.pe < 12) bull += 1.5; // Very undervalued
        else if (quote.pe < 18) bull += 1; // Undervalued
        else if (quote.pe < 25) bull += 0.5; // Reasonable valuation
        else if (quote.pe < 35) bear += 0.5; // Slightly expensive
        else bear += 1; // Overvalued
      }
      
      // Market Sentiment Factor (NEW - adds realism)
      const marketSentiment = 0.2; // Slight bullish bias for current market
      bull += marketSentiment; // Add slight bullish bias to all stocks

      // Market Cap Analysis
      if (quote.marketCap) {
        if (quote.marketCap > 1e12) { // Large cap - more stable
          bull *= 1.1;
          bear *= 1.1;
        } else if (quote.marketCap < 1e9) { // Small cap - more volatile
          bull *= 0.9;
          bear *= 0.9;
        }
      }

        const total = bull + bear;
        const ratio = total > 0 ? bull / total : 0.5;
        const direction = ratio > 0.5 ? 'bullish' : 'bearish';
        const confidence = Math.round(Math.min(Math.abs(ratio - 0.5) * 2, 0.95) * 100);
        
        return {
          direction, 
          confidence, 
          bullishRatio: ratio,
          indicators: {
            rsi, macd, sma20, sma50, bb, stoch, williamsR, atr, volatility: vol
          }
        };
      } catch (error) {
        console.error('Prediction generation error:', error);
        return { 
          direction: 'bullish', 
          confidence: 50, 
          bullishRatio: 0.5, 
          indicators: {} 
        };
      }
    }

    function generatePredictionPath(quote, history, predictionDays = selectedPredictionDays) {
      try {
        const pred = generatePrediction(quote, history);
        if (!history || history.length === 0) {
          return { 
            pred: { direction: 'bullish', confidence: 50, bullishRatio: 0.5 }, 
            data: [], 
            summary: { period: '0 days', change: 0, changePercent: 0, confidence: 50, targetPrice: quote.price }
          };
        }
        
        const last = history[history.length - 1].price;
        const out = [];
      
      // Adjust base drift based on prediction timeframe (FIXED - more realistic)
      let baseDrift, noiseFactor;
      const bullishStrength = Math.abs(pred.bullishRatio - 0.5) * 2; // 0 to 1
      
      if (predictionDays === 1) {
        baseDrift = pred.direction === 'bullish' ? 0.015 * bullishStrength : -0.015 * bullishStrength; // 1-day prediction
        noiseFactor = 0.002;
      } else if (predictionDays === 7) {
        baseDrift = pred.direction === 'bullish' ? 0.004 * bullishStrength : -0.004 * bullishStrength; // 1-week prediction
        noiseFactor = 0.0015;
      } else {
        baseDrift = pred.direction === 'bullish' ? 0.0025 * bullishStrength : -0.0025 * bullishStrength; // 30-day prediction
        noiseFactor = 0.001;
      }
      
      for (let i = 1; i <= predictionDays; i++) {
        const drift = baseDrift * (i / predictionDays); // Scale drift over time
        const noise = (Math.sin(i/3) + Math.sin(i/7)) * noiseFactor; // smooth wiggles
        const next = Math.max(last * (1 + drift + noise), last * 0.7);
        out.push({ date: new Date(Date.now() + i*86400000), price: next });
      }
      
      // Calculate prediction summary
      const finalPrice = out[out.length - 1].price;
      const change = finalPrice - last;
      const changePercent = (change / last) * 100;
      
        return { 
          pred, 
          data: out, 
          summary: {
            period: `${predictionDays} day${predictionDays > 1 ? 's' : ''}`,
            change: change,
            changePercent: changePercent,
            confidence: pred.confidence,
            targetPrice: finalPrice,
            startDate: new Date(),
            endDate: new Date(Date.now() + predictionDays * 86400000)
          }
        };
      } catch (error) {
        console.error('Prediction path generation error:', error);
        return { 
          pred: { direction: 'bullish', confidence: 50, bullishRatio: 0.5 }, 
          data: [], 
          summary: { 
            period: `${predictionDays} day${predictionDays > 1 ? 's' : ''}`, 
            change: 0, 
            changePercent: 0, 
            confidence: 50, 
            targetPrice: quote.price 
          }
        };
      }
    }

    function drawPriceChart(history) {
      const ctx = document.getElementById('priceChart').getContext('2d');
      if (priceChart) priceChart.destroy();
      priceChart = new Chart(ctx, {
        type: 'line',
        data: { labels: history.map(d => d.date.toLocaleDateString()), datasets: [{ label: 'Price', data: history.map(d => d.price), borderColor: '#5b7bd5', backgroundColor: 'rgba(91,123,213,0.12)', fill: true, borderWidth: 2, tension: 0.35, pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.08)' } } }, interaction: { intersect: false, mode: 'index' } }
      });
    }

    function drawPredictionChart(path, summary) {
      try {
        const ctx = document.getElementById('predictionChart').getContext('2d');
        if (predictionChart) predictionChart.destroy();
        
        if (!path || path.length === 0 || !summary) {
          console.error('Invalid prediction data for chart');
          return;
        }
      
      // Format labels based on prediction timeframe
      let labels;
      if (selectedPredictionDays === 1) {
        labels = path.map((d, i) => {
          const date = d.date;
          return i === 0 ? 'Today' : `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
        });
      } else if (selectedPredictionDays === 7) {
        labels = path.map((d, i) => {
          const date = d.date;
          return i === 0 ? 'Today' : `${date.getMonth() + 1}/${date.getDate()}`;
        });
      } else {
        labels = path.map((d, i) => {
          const date = d.date;
          return i === 0 ? 'Today' : `${date.getMonth() + 1}/${date.getDate()}`;
        });
      }
      
      // Determine chart color based on prediction direction
      const isBullish = summary.change > 0;
      const borderColor = isBullish ? '#1f9d57' : '#d64545';
      const backgroundColor = isBullish ? 'rgba(31,157,87,0.10)' : 'rgba(214,69,69,0.10)';
      
      predictionChart = new Chart(ctx, {
        type: 'line',
        data: { 
          labels: labels, 
          datasets: [{ 
            label: 'Predicted Price', 
            data: path.map(d => d.price), 
            borderColor: borderColor, 
            backgroundColor: backgroundColor, 
            fill: true, 
            borderWidth: 3, 
            tension: 0.4, 
            pointRadius: selectedPredictionDays === 1 ? 3 : 0,
            pointHoverRadius: 5,
            borderDash: selectedPredictionDays === 1 ? [] : [5,4]
          }] 
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const dataIndex = context[0].dataIndex;
                  const date = path[dataIndex].date;
                  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                },
                label: function(context) {
                  return `Predicted: ${formatCurrency(context.parsed.y)}`;
                }
              }
            }
          }, 
          scales: { 
            x: { 
              display: true,
              grid: { color: 'rgba(0,0,0,0.08)' },
              ticks: {
                maxTicksLimit: selectedPredictionDays === 1 ? 8 : 10
              }
            }, 
            y: { 
              beginAtZero: false, 
              grid: { color: 'rgba(0,0,0,0.08)' },
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            } 
          }, 
          interaction: { intersect: false, mode: 'index' } 
        }
      });
      } catch (error) {
        console.error('Prediction chart drawing error:', error);
      }
    }

    function updateMoodChart(pred) {
      try {
        const ctx = document.getElementById('moodChart').getContext('2d');
        if (moodChart) moodChart.destroy();
        
        if (!pred || typeof pred.bullishRatio !== 'number') {
          console.error('Invalid prediction data for mood chart');
          return;
        }
        
        const bull = Math.round(pred.bullishRatio * 100);
        const bear = 100 - bull;
        moodChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Bullish','Bearish'], datasets: [{ data: [bull, bear], backgroundColor: ['#1f9d57','#d64545'], borderWidth: 0 }] }, options: { plugins: { legend: { display: false } } } });
        document.getElementById('bullPct').textContent = `${bull}%`;
        document.getElementById('bearPct').textContent = `${bear}%`;
      } catch (error) {
        console.error('Mood chart update error:', error);
      }
    }

    function updatePredictionSummary(summary) {
      document.getElementById('predictionPeriod').textContent = summary.period;
      
      const changeElement = document.getElementById('expectedChange');
      const changePercent = summary.changePercent;
      const changeText = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
      changeElement.innerHTML = `<span class="${changePercent >= 0 ? 'bull' : 'bear'}">${changeText}</span>`;
      
      document.getElementById('predictionConfidence').textContent = `${summary.confidence}%`;
      document.getElementById('targetPrice').textContent = formatCurrency(summary.targetPrice);
    }

    function fillKpis(quote) {
      document.getElementById('kpiPrice').textContent = formatCurrency(quote.price, quote.currency);
      const ch = quote.change; const chp = quote.changePercent;
      const sign = ch > 0 ? '+' : '';
      document.getElementById('kpiChange').innerHTML = `<span class="${ch >= 0 ? 'bull' : 'bear'}">${sign}${ch?.toFixed?.(2) ?? ch} (${sign}${chp?.toFixed?.(2) ?? chp}%)</span>`;
      document.getElementById('kpiVolume').textContent = formatNumber(quote.volume);
      document.getElementById('kpiMcap').textContent = formatMcap(quote.marketCap);
      document.getElementById('kpiPE').textContent = quote.pe?.toFixed ? quote.pe.toFixed(1) : (quote.pe ?? '-');
      document.getElementById('kpiPrev').textContent = formatCurrency(quote.previousClose, quote.currency);
      document.getElementById('kpiHigh').textContent = formatCurrency(quote.dayHigh, quote.currency);
      document.getElementById('kpiLow').textContent = formatCurrency(quote.dayLow, quote.currency);
    }

    async function testAlphaVantage(symbol) {
      const comp = document.getElementById('dataComparison');
      comp.innerHTML = '<div>Testing Alpha Vantage...</div>';
      
      try {
        const data = await fetchAlphaVantageQuote(symbol);
        const time = new Date(data.asOfISO).toLocaleTimeString();
        const quality = data.dataQuality === 'real-time' ? 'üü¢' : 'üü°';
        
        let html = `
          <div style="margin-bottom:10px;"><strong>Alpha Vantage Data:</strong></div>
          <div style="margin-bottom:5px;">Price: <strong>$${data.price?.toFixed(2)}</strong> ${quality}</div>
          <div style="margin-bottom:5px;">Change: <strong>${data.change >= 0 ? '+' : ''}${data.change?.toFixed(2)} (${data.changePercent >= 0 ? '+' : ''}${data.changePercent?.toFixed(2)}%)</strong></div>
          <div style="margin-bottom:5px;">Volume: <strong>${formatNumber(data.volume)}</strong></div>
          <div style="margin-bottom:5px;">Time: <strong>${time}</strong></div>
          <div style="margin-bottom:5px;">Quality: <strong>${data.dataQuality}</strong></div>
          
          <div style="margin-top:10px; font-size:11px; color:#999; border-top:1px solid #eee; padding-top:8px;">
            <div><strong>Alpha Vantage Features:</strong></div>
            <div>‚Ä¢ Real-time stock quotes</div>
            <div>‚Ä¢ 20+ years historical data</div>
            <div>‚Ä¢ Professional technical indicators</div>
            <div>‚Ä¢ Global market coverage</div>
            <div>‚Ä¢ Institutional-grade data</div>
          </div>
        `;
        
        comp.innerHTML = html;
      } catch (e) {
        comp.innerHTML = `<div style="color:#e74c3c;">Error testing Alpha Vantage: ${e.message}</div>`;
      }
    }

    function updateDataComparison(symbol, currentQuote) {
      const comp = document.getElementById('dataComparison');
      comp.innerHTML = `
        <div style="margin-bottom:8px;"><strong>Alpha Vantage Data</strong></div>
        <div style="margin-bottom:8px;">Price: <strong>$${currentQuote.price?.toFixed(2)}</strong></div>
        <div style="margin-bottom:8px;">Time: ${new Date(currentQuote.asOfISO || Date.now()).toLocaleTimeString()}</div>
        <div style="margin-bottom:8px;">Quality: <strong>${currentQuote.dataQuality || 'real-time'}</strong></div>
        <div style="margin-bottom:8px;">Session: ${currentQuote.session || 'REGULAR'}</div>
        <div style="font-size:11px; color:#999;">
          <div><strong>Alpha Vantage Benefits:</strong></div>
          <div>‚Ä¢ Real-time market data</div>
          <div>‚Ä¢ Professional accuracy</div>
          <div>‚Ä¢ 20+ years history</div>
          <div>‚Ä¢ Institutional grade</div>
        </div>
      `;
    }

    function fillInfo(quote) {
      const info = document.getElementById('stockInfo');
      const source = (quote.provider || '').toUpperCase();
      const asOf = quote.asOfISO ? new Date(quote.asOfISO) : new Date();
      const delayedBadge = quote.isDelayed ? ' (Delayed)' : '';
      const session = quote.session || 'REGULAR';
      const dataQuality = quote.dataQuality || 'unknown';
      const qualityBadge = dataQuality === 'real-time' ? ' üü¢' : dataQuality === 'delayed' ? ' üü°' : ' ‚ö™';
      info.innerHTML = `
        <div class="info"><div class="label">Symbol</div><div class="value">${quote.symbol} (${quote.exchangeName})</div></div>
        <div class="info"><div class="label">Company</div><div class="value">${quote.name}</div></div>
        <div class="info"><div class="label">Currency</div><div class="value">${quote.currency || 'USD'}</div></div>
        <div class="info"><div class="label">Session</div><div class="value">${session}</div></div>
        <div class="info"><div class="label">Data Source</div><div class="value">${source || 'YAHOO'}${delayedBadge}${qualityBadge}</div></div>
        <div class="info"><div class="label">As of</div><div class="value">${asOf.toLocaleString()}</div></div>
      `;
      
      // Update comparison
      updateDataComparison(quote.symbol, quote);
    }

    function populateInitialDatalist() {
      const dl = document.getElementById('stockSuggestions');
      if (!dl) return;
      dl.innerHTML = '';
      // Put NASDAQ first
      const ordered = [...localCompanies.filter(c => c.e === 'NASDAQ'), ...localCompanies.filter(c => c.e !== 'NASDAQ')];
      ordered.slice(0, 50).forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.s;
        opt.label = `${c.n} (${c.e})`;
        dl.appendChild(opt);
      });
    }

    function findLocalByQuery(query) {
      const q = query.trim();
      if (!q) return null;
      const sym = q.toUpperCase();
      const exact = localCompanies.find(c => c.s === sym);
      if (exact) return exact;
      const nameMatch = localCompanies.find(c => c.n.toLowerCase().includes(q.toLowerCase()));
      return nameMatch || null;
    }

    async function analyze(symbolOrName) {
      const query = (symbolOrName || document.getElementById('stockInput').value).trim();
      if (!query) { alert('Enter a symbol or company name'); return; }

      // Prefer local resolution first
      let resolved = findLocalByQuery(query);
      let symbol = resolved?.s || query.toUpperCase();
      let exchangeName = resolved?.e || null;
      let nameOverride = resolved?.n || null;

      // If still not clearly a symbol, use API search
      if (!/^[A-Z.]{1,6}$/.test(symbol)) {
        try {
          const results = await resolveSymbolFromApi(query);
          if (results.length) {
            const preferred = results.find(q => q.exchDisp === 'NASDAQ' || q.exchange === 'NMS') || results[0];
            symbol = preferred.symbol.toUpperCase();
            exchangeName = preferred.exchDisp || preferred.exchange || exchangeName;
            nameOverride = preferred.longname || preferred.shortname || nameOverride;
          }
        } catch {}
      }

      currentSymbol = symbol;
      currentExchange = exchangeName;

      document.getElementById('histTitle').textContent = `Historical Price (${document.querySelector('.tf.active').textContent})`;

      const [quote, history] = await Promise.all([
        safeFetchLiveQuote(symbol),
        safeFetchStockHistory(symbol, selectedRange)
      ]);

      if (nameOverride) quote.name = nameOverride;
      if (exchangeName && quote.exchangeName === '‚Äî') quote.exchangeName = exchangeName;

      // Store current data for investment recommendations
      currentQuote = quote;
      currentHistory = history;

      fillKpis(quote);
      fillInfo(quote);

      drawPriceChart(history);

      const { pred, data, summary } = generatePredictionPath(quote, history, selectedPredictionDays);
      drawPredictionChart(data, summary);
      updateMoodChart(pred);
      updatePredictionSummary(summary);

      // Update prediction title
      const predictionTitle = document.getElementById('predictionTitle');
      const timeframeLabels = { 1: '1-Day', 7: '1-Week', 30: '30-Day' };
      predictionTitle.textContent = `${timeframeLabels[selectedPredictionDays]} Prediction`;

      document.getElementById('predictionText').innerHTML = `${pred.direction === 'bullish' ? '<span class="bull">Bullish</span>' : '<span class="bear">Bearish</span>'} outlook next ${summary.period} ‚Ä¢ Confidence ${pred.confidence}%`;
      document.getElementById('results').style.display = 'block';

      // Generate initial investment recommendation (default to day trading)
      generateInvestmentRecommendation('day');

      startLiveUpdates();
    }

    function startLiveUpdates() {
      if (liveTimer) { clearInterval(liveTimer); liveTimer = null; }
      if (!currentSymbol) return;
      liveTimer = setInterval(async () => {
        try {
          const q = await safeFetchLiveQuote(currentSymbol);
          fillKpis(q);
        } catch {}
      }, 30000);
    }

    // Investment guidance toggle functionality
    function toggleInvestmentGuide(strategy) {
      const dayTradingBtn = document.getElementById('dayTradingBtn');
      const longTermBtn = document.getElementById('longTermBtn');
      
      if (strategy === 'day') {
        dayTradingBtn.style.background = '#5b7bd5';
        longTermBtn.style.background = '#6b7a90';
      } else {
        dayTradingBtn.style.background = '#6b7a90';
        longTermBtn.style.background = '#5b7bd5';
      }
      
      // Update recommendation if stock is analyzed
      if (currentSymbol && currentQuote && currentHistory) {
        generateInvestmentRecommendation(strategy);
      }
    }

    // Generate comprehensive investment recommendation
    function generateInvestmentRecommendation(strategy) {
      if (!currentQuote || !currentHistory) return;
      
      const prices = currentHistory.map(d => d.price);
      const currentPrice = currentQuote.price;
      const rsi = calculateRSI(prices);
      const macd = calculateMACD(prices);
      const sma20 = calculateSMA(prices, 20);
      const sma50 = calculateSMA(prices, 50);
      const bb = calculateBollingerBands(prices);
      const stoch = calculateStochastic(prices);
      const williamsR = calculateWilliamsR(prices);
      const volume = currentQuote.volume;
      const pe = currentQuote.pe;
      const marketCap = currentQuote.marketCap;
      const volatility = calculateVolatility(prices);
      
      let bullishSignals = 0;
      let bearishSignals = 0;
      let technicalSignals = [];
      let riskFactors = [];
      let guidelines = [];
      
      if (strategy === 'day') {
        // Day Trading Analysis
        technicalSignals.push('<strong>üìà Day Trading Signals:</strong>');
        
        // RSI Analysis
        if (rsi < 30) {
          bullishSignals += 2;
          technicalSignals.push('‚úÖ RSI oversold (' + rsi.toFixed(1) + ') - Strong bounce opportunity');
        } else if (rsi > 70) {
          bearishSignals += 2;
          technicalSignals.push('‚ùå RSI overbought (' + rsi.toFixed(1) + ') - Sell signal');
        } else if (rsi < 40) {
          bullishSignals += 1;
          technicalSignals.push('üü° RSI weak oversold (' + rsi.toFixed(1) + ')');
        } else if (rsi > 60) {
          bearishSignals += 1;
          technicalSignals.push('üü° RSI weak overbought (' + rsi.toFixed(1) + ')');
        } else {
          technicalSignals.push('‚ö™ RSI neutral (' + rsi.toFixed(1) + ')');
        }
        
        // Bollinger Bands
        if (currentPrice < bb.lower) {
          bullishSignals += 2;
          technicalSignals.push('‚úÖ Price at lower Bollinger Band - Oversold');
        } else if (currentPrice > bb.upper) {
          bearishSignals += 2;
          technicalSignals.push('‚ùå Price at upper Bollinger Band - Overbought');
        } else if (currentPrice > bb.middle) {
          bullishSignals += 0.5;
          technicalSignals.push('üü° Price above middle Bollinger Band');
        } else {
          bearishSignals += 0.5;
          technicalSignals.push('üü° Price below middle Bollinger Band');
        }
        
        // MACD
        if (macd.macd > macd.signal) {
          bullishSignals += 1;
          technicalSignals.push('‚úÖ MACD bullish crossover');
        } else {
          bearishSignals += 1;
          technicalSignals.push('‚ùå MACD bearish crossover');
        }
        
        // Stochastic
        if (stoch.k < 20 && stoch.d < 20) {
          bullishSignals += 1;
          technicalSignals.push('‚úÖ Stochastic oversold (' + stoch.k.toFixed(1) + ')');
        } else if (stoch.k > 80 && stoch.d > 80) {
          bearishSignals += 1;
          technicalSignals.push('‚ùå Stochastic overbought (' + stoch.k.toFixed(1) + ')');
        } else {
          technicalSignals.push('‚ö™ Stochastic neutral (' + stoch.k.toFixed(1) + ')');
        }
        
        // Volume Analysis
        if (volume > 50_000_000) {
          technicalSignals.push('üìä High volume - Good liquidity for day trading');
        } else if (volume < 10_000_000) {
          technicalSignals.push('‚ö†Ô∏è Low volume - Higher slippage risk');
        }
        
        // Risk Assessment for Day Trading
        riskFactors.push('<strong>‚ö†Ô∏è Day Trading Risks:</strong>');
        if (volatility > 0.05) {
          riskFactors.push('üî¥ High volatility (' + (volatility * 100).toFixed(1) + '%) - Increased risk');
        } else if (volatility < 0.02) {
          riskFactors.push('üü¢ Low volatility (' + (volatility * 100).toFixed(1) + '%) - Lower risk');
        } else {
          riskFactors.push('üü° Moderate volatility (' + (volatility * 100).toFixed(1) + '%)');
        }
        
        if (marketCap < 1e9) {
          riskFactors.push('üî¥ Small cap - Higher volatility risk');
        } else if (marketCap > 1e12) {
          riskFactors.push('üü¢ Large cap - More stable');
        }
        
        // Guidelines
        guidelines.push('<strong>üìã Day Trading Guidelines:</strong>');
        guidelines.push('‚Ä¢ Entry: Wait for RSI < 30 or price at lower Bollinger Band');
        guidelines.push('‚Ä¢ Exit: Take profit at RSI > 70 or upper Bollinger Band');
        guidelines.push('‚Ä¢ Stop Loss: Set 2-3% below entry price');
        guidelines.push('‚Ä¢ Position Size: Max 5-10% of portfolio');
        guidelines.push('‚Ä¢ Best Times: First 30 min and last 30 min of trading day');
        
      } else {
        // Long-term Analysis
        technicalSignals.push('<strong>üìä Long-term Signals:</strong>');
        
        // Moving Averages
        if (currentPrice > sma20 && sma20 > sma50) {
          bullishSignals += 2;
          technicalSignals.push('‚úÖ Strong uptrend (price > SMA20 > SMA50)');
        } else if (currentPrice < sma20 && sma20 < sma50) {
          bearishSignals += 2;
          technicalSignals.push('‚ùå Strong downtrend');
        } else if (currentPrice > sma20) {
          bullishSignals += 1;
          technicalSignals.push('üü° Price above short-term MA');
        } else {
          bearishSignals += 1;
          technicalSignals.push('üü° Price below short-term MA');
        }
        
        // RSI for long-term
        if (rsi >= 40 && rsi <= 60) {
          bullishSignals += 1;
          technicalSignals.push('‚úÖ RSI in healthy range (' + rsi.toFixed(1) + ')');
        } else if (rsi > 75) {
          bearishSignals += 1;
          technicalSignals.push('‚ùå RSI overbought for long-term (' + rsi.toFixed(1) + ')');
        } else if (rsi < 25) {
          bullishSignals += 1;
          technicalSignals.push('‚úÖ RSI oversold - potential buying opportunity');
        } else {
          technicalSignals.push('‚ö™ RSI neutral (' + rsi.toFixed(1) + ')');
        }
        
        // P/E Ratio Analysis
        if (pe && pe < 20) {
          bullishSignals += 1;
          technicalSignals.push('‚úÖ Reasonable P/E ratio (' + pe.toFixed(1) + ')');
        } else if (pe && pe > 35) {
          bearishSignals += 1;
          technicalSignals.push('‚ùå High P/E ratio (' + pe.toFixed(1) + ') - Overvalued');
        } else if (pe) {
          technicalSignals.push('‚ö™ Moderate P/E ratio (' + pe.toFixed(1) + ')');
        }
        
        // Market Cap Analysis
        if (marketCap > 1e12) {
          technicalSignals.push('üè¢ Large cap ($' + formatMcap(marketCap) + ') - Stable for long-term');
        } else if (marketCap < 1e9) {
          technicalSignals.push('‚ö†Ô∏è Small cap ($' + formatMcap(marketCap) + ') - Higher risk');
        } else {
          technicalSignals.push('üè¢ Mid cap ($' + formatMcap(marketCap) + ') - Moderate risk');
        }
        
        // Risk Assessment for Long-term
        riskFactors.push('<strong>‚ö†Ô∏è Long-term Risks:</strong>');
        if (volatility > 0.04) {
          riskFactors.push('üî¥ High volatility - Expect significant price swings');
        } else if (volatility < 0.015) {
          riskFactors.push('üü¢ Low volatility - Stable price movement');
        } else {
          riskFactors.push('üü° Moderate volatility - Normal market behavior');
        }
        
        if (pe && pe > 30) {
          riskFactors.push('üî¥ High valuation risk - P/E ratio elevated');
        }
        
        if (marketCap < 1e9) {
          riskFactors.push('üî¥ Small cap risk - Higher volatility and liquidity risk');
        }
        
        // Guidelines
        guidelines.push('<strong>üìã Long-term Guidelines:</strong>');
        guidelines.push('‚Ä¢ Buy: Price above both SMA20 and SMA50, RSI 40-60');
        guidelines.push('‚Ä¢ Hold: Maintain position if trend continues');
        guidelines.push('‚Ä¢ Sell: Price breaks below SMA50, RSI > 75');
        guidelines.push('‚Ä¢ Diversification: Max 20-30% in single position');
        guidelines.push('‚Ä¢ Rebalancing: Review quarterly, adjust annually');
      }
      
      // Calculate final recommendation
      const totalSignals = bullishSignals + bearishSignals;
      const bullishRatio = totalSignals > 0 ? bullishSignals / totalSignals : 0.5;
      const confidence = Math.round(Math.min(Math.abs(bullishRatio - 0.5) * 2, 0.95) * 100);
      
      let recommendation = '';
      let recommendationColor = '';
      
      if (bullishRatio > 0.6) {
        recommendation = 'üü¢ BUY';
        recommendationColor = '#1f9d57';
      } else if (bullishRatio < 0.4) {
        recommendation = 'üî¥ SELL';
        recommendationColor = '#d64545';
      } else {
        recommendation = 'üü° HOLD';
        recommendationColor = '#f39c12';
      }
      
      // Update the main recommendation display
      document.getElementById('recommendationText').innerHTML = 
        `<span style="color: ${recommendationColor}; font-size: 24px;">${recommendation}</span>`;
      
      document.getElementById('confidenceLevel').textContent = 
        `Confidence: ${confidence}% | Strategy: ${strategy === 'day' ? 'Day Trading' : 'Long-term'}`;
      
      // Update technical signals
      document.getElementById('technicalSignals').innerHTML = 
        technicalSignals.map(signal => `<div style="margin-bottom: 4px;">${signal}</div>`).join('');
      
      // Update risk assessment
      document.getElementById('riskAssessment').innerHTML = 
        riskFactors.map(risk => `<div style="margin-bottom: 4px;">${risk}</div>`).join('');
      
      // Update guidelines
      document.getElementById('guidelinesContent').innerHTML = 
        guidelines.map(guideline => `<div style="margin-bottom: 4px;">${guideline}</div>`).join('');
      
      // Show the investment analysis section
      document.getElementById('investmentAnalysis').style.display = 'block';
    }

    async function loadAlphaVantageIndicators() {
      if (!currentSymbol) {
        alert('Please analyze a stock first');
        return;
      }

      const indicatorsContent = document.getElementById('indicatorsContent');
      const loadBtn = document.getElementById('loadIndicatorsBtn');
      
      loadBtn.textContent = 'Loading...';
      loadBtn.disabled = true;
      
      try {
        const indicators = await fetchAlphaVantageIndicators(currentSymbol);
        
        if (indicators) {
          let html = '<div style="margin-bottom: 10px;"><strong>Professional Technical Analysis:</strong></div>';
          
          // RSI Analysis
          if (indicators.rsi) {
            const rsiEntries = Object.entries(indicators.rsi);
            const latestRSI = rsiEntries[0];
            if (latestRSI) {
              const rsiValue = parseFloat(latestRSI[1]['RSI']);
              const rsiStatus = rsiValue < 30 ? 'üî¥ Oversold' : rsiValue > 70 ? 'üü¢ Overbought' : '‚ö™ Neutral';
              html += `<div style="margin-bottom: 4px;">üìà RSI: <strong>${rsiValue.toFixed(2)}</strong> ${rsiStatus}</div>`;
            }
          }
          
          // MACD Analysis
          if (indicators.macd) {
            const macdEntries = Object.entries(indicators.macd);
            const latestMACD = macdEntries[0];
            if (latestMACD) {
              const macdValue = parseFloat(latestMACD[1]['MACD']);
              const signalValue = parseFloat(latestMACD[1]['MACD_Signal']);
              const histogramValue = parseFloat(latestMACD[1]['MACD_Hist']);
              const macdStatus = macdValue > signalValue ? 'üü¢ Bullish' : 'üî¥ Bearish';
              html += `<div style="margin-bottom: 4px;">üìä MACD: <strong>${macdValue.toFixed(4)}</strong> ${macdStatus}</div>`;
              html += `<div style="margin-bottom: 4px;">üìà Signal: <strong>${signalValue.toFixed(4)}</strong></div>`;
              html += `<div style="margin-bottom: 4px;">üìâ Histogram: <strong>${histogramValue.toFixed(4)}</strong></div>`;
            }
          }
          
          // SMA Analysis
          if (indicators.sma20 && indicators.sma50) {
            const sma20Entries = Object.entries(indicators.sma20);
            const sma50Entries = Object.entries(indicators.sma50);
            const latestSMA20 = sma20Entries[0];
            const latestSMA50 = sma50Entries[0];
            
            if (latestSMA20 && latestSMA50) {
              const sma20Value = parseFloat(latestSMA20[1]['SMA']);
              const sma50Value = parseFloat(latestSMA50[1]['SMA']);
              const trendStatus = sma20Value > sma50Value ? 'üü¢ Uptrend' : 'üî¥ Downtrend';
              html += `<div style="margin-bottom: 4px;">üìà SMA 20: <strong>$${sma20Value.toFixed(2)}</strong></div>`;
              html += `<div style="margin-bottom: 4px;">üìà SMA 50: <strong>$${sma50Value.toFixed(2)}</strong></div>`;
              html += `<div style="margin-bottom: 4px;">üìä Trend: <strong>${trendStatus}</strong></div>`;
            }
          }
          
          html += '<div style="margin-top: 10px; font-size: 11px; color: #6b7a90;">Data provided by Alpha Vantage API</div>';
          indicatorsContent.innerHTML = html;
        } else {
          indicatorsContent.innerHTML = '<div style="color: #d64545;">Failed to load Alpha Vantage indicators. Using calculated values instead.</div>';
        }
      } catch (error) {
        indicatorsContent.innerHTML = `<div style="color: #d64545;">Error loading indicators: ${error.message}</div>`;
      } finally {
        loadBtn.textContent = 'Load Alpha Vantage Indicators';
        loadBtn.disabled = false;
      }
    }

    // Events
    document.getElementById('analyzeBtn').addEventListener('click', () => analyze());
    document.getElementById('stockInput').addEventListener('input', debounce(updateSuggestions, 250));
    document.getElementById('stockInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') analyze(); });
    document.getElementById('testProvidersBtn').addEventListener('click', () => {
      if (currentSymbol) testAlphaVantage(currentSymbol);
      else alert('Please analyze a stock first');
    });
    document.getElementById('dayTradingBtn').addEventListener('click', () => toggleInvestmentGuide('day'));
    document.getElementById('longTermBtn').addEventListener('click', () => toggleInvestmentGuide('long'));
    document.getElementById('loadIndicatorsBtn').addEventListener('click', loadAlphaVantageIndicators);
    
    // Historical timeframe buttons
    document.querySelectorAll('.tf:not(.prediction-tf)').forEach(btn => btn.addEventListener('click', async (e) => {
      document.querySelectorAll('.tf:not(.prediction-tf)').forEach(b => b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      selectedRange = e.currentTarget.getAttribute('data-range');
      selectedDays = Number(e.currentTarget.getAttribute('data-days'));
      if (currentSymbol) {
        try {
          document.getElementById('histTitle').textContent = `Historical Price (${e.currentTarget.textContent})`;
          const history = await safeFetchStockHistory(currentSymbol, selectedRange);
          drawPriceChart(history);
          const q = await safeFetchLiveQuote(currentSymbol);
          const { pred, data, summary } = generatePredictionPath(q, history, selectedPredictionDays);
          drawPredictionChart(data, summary);
          updatePredictionSummary(summary);
        } catch {}
      }
    }));
    
    // Prediction timeframe buttons
    document.querySelectorAll('.prediction-tf').forEach(btn => btn.addEventListener('click', async (e) => {
      document.querySelectorAll('.prediction-tf').forEach(b => b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      selectedPredictionDays = Number(e.currentTarget.getAttribute('data-days'));
      
      if (currentSymbol && currentQuote && currentHistory) {
        try {
          const { pred, data, summary } = generatePredictionPath(currentQuote, currentHistory, selectedPredictionDays);
          drawPredictionChart(data, summary);
          updatePredictionSummary(summary);
          
          // Update prediction title
          const predictionTitle = document.getElementById('predictionTitle');
          const timeframeLabels = { 1: '1-Day', 7: '1-Week', 30: '30-Day' };
          predictionTitle.textContent = `${timeframeLabels[selectedPredictionDays]} Prediction`;
          
          // Update prediction text
          document.getElementById('predictionText').innerHTML = `${pred.direction === 'bullish' ? '<span class="bull">Bullish</span>' : '<span class="bear">Bearish</span>'} outlook next ${summary.period} ‚Ä¢ Confidence ${pred.confidence}%`;
        } catch {}
      }
    }));

    function debounce(fn, wait) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null, args), wait); }; }

    // Initialize datalist on load
    window.addEventListener('DOMContentLoaded', populateInitialDatalist);
    </script>
</body>
</html>
